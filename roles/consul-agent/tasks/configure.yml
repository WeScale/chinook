---
- name: create data directory
  file:
    path: "{{ consul_data_dir }}"
    state: directory
    mode: 0700
    owner: "{{ consul_user_name }}"
    group: "{{ consul_user_name }}"

- name: create configuration directory
  file:
    path: "{{ item }}"
    state: directory
    mode: 0750
    owner: root
    group: "{{ consul_user_name }}"
  with_items:
    - "{{ consul_config_dir }}"
    - "{{ consul_config_dir }}/tls"

- set_fact:
    consul_node_tls_workdir: "{{ consul_local_tls_dir }}/{{ inventory_hostname }}"

- name: local certificates generation
  include: local_ca_certificate.yml
  delegate_to: localhost
  become: no
  run_once: true

- name: certificate upload
  copy:
    src: "{{ consul_local_tls_dir }}/consul-root.cer"
    dest: "{{ consul_config_dir }}/tls/consul-root.cer"

- name: create node cert signing
  shell: >-
    openssl req
    -newkey rsa:4096
    -nodes
    -subj "{{ consul_node_cert_subj }}"
    -out {{ consul_config_dir }}/tls/consul-node.csr
    -keyout {{ consul_config_dir }}/tls/consul-node.key
    && chown root:{{ consul_user_name}} *
    && chmod 640 *
  args:
    warn: no
    chdir: "{{ consul_config_dir }}/tls"
    creates: "{{ consul_config_dir }}/tls/consul-node.csr"

- fetch:
    src: "{{ consul_config_dir }}/tls/consul-node.csr"
    flat: yes
    dest: "{{ consul_node_tls_workdir }}/consul-node.csr"

- file:
    path: "{{ consul_node_tls_workdir }}/consul-node.cer.index"
    state: touch
  changed_when: false
  delegate_to: localhost
  become: no

- name: generate consulca node-specific conf
  template:
    src: consulca.conf.j2
    dest: "{{ consul_node_tls_workdir }}/consulca.conf"
  delegate_to: localhost
  become: no

- stat:
    path: "{{ consul_node_tls_workdir }}/consul-node.cer.serial"
  register: node_ca_serial
  delegate_to: localhost
  become: no

- copy:
    dest: "{{ consul_node_tls_workdir }}/consul-node.cer.serial"
    content: "0A"
  when: not node_ca_serial.stat.exists
  delegate_to: localhost
  become: no

- name: create node specific signed cert
  shell: >-
    openssl ca -batch -notext -in consul-node.csr -out consul-node.cer -config consulca.conf
  args:
    chdir: "{{ consul_node_tls_workdir }}"
    creates: "{{ consul_node_tls_workdir }}/consul-node.cer"
  delegate_to: localhost
  become: no

- copy:
    src: "{{ consul_node_tls_workdir }}/consul-node.cer"
    dest: "{{ consul_config_dir }}/tls/consul-node.cer"
    owner: root
    group: "{{ consul_user_name }}"
    mode: 0640

- name: generate agent configuration
  template:
    src: "config.json.j2"
    dest: "{{ consul_config_dir }}/config.json"
    owner: root
    group: "{{ consul_user_name }}"
    mode: 0640
    validate: >-
      consul validate %s
  notify: restart consul

- name: generate ui configuration for servers
  template:
    src: "{{ consul_mode }}/consul-service-ui.json.j2"
    dest: "{{ consul_config_dir }}/service-ui.json"
    group: "{{ consul_user_name }}"
    mode: 0640
    validate: >-
      consul validate %s
  notify: restart consul
  when: consul_mode == 'server'

- name: generate default variables
  template:
    src: "{{ consul_mode }}/defaults.j2"
    dest: "/etc/default/consul"
    group: "{{ consul_user_name }}"
    mode: "0640"
  notify: restart consul
